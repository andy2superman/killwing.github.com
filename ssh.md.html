<!DOCTYPE html>
<html>
<title>SSH</title>
<xmp theme="readable" style="display:none;">
SSH采用非对称加密，没有CA，由用户自己评估风险。

## 密码登录
步骤：

1. client请求登录server。
1. server把自己的公钥发给client，client端第一次会显示此公钥的128位指纹以供用户评估核对，若同意则保存在`~/.ssh/known_hosts`中。
1. client使用这个公钥加密登录密码发回给server。
1. server用自己的私钥解密并验证登录密码，若正确则同意client登录。

## 公钥登录（免密码登录）
步骤：

1. client请求登录server。
1. server发回一段随机字符串给client。
1. client用自己的私钥加密此字符串后发给server。
1. server用client事先保存在server上的公钥进行解密验证，若正确则同意登录。

client必须生成自己的公钥私钥对，并把公钥保存到server上。
生成：`ssh-keygen -t rsa`并一路回车，生成的公钥`~/.ssh/id_rsa.pub`，私钥`~/.ssh/id_rsa`。
保存公钥到server：`ssh-copy-id user@server`，公钥会被保存到server的`~/.ssh/authorized_keys`中。等价命令`cat ~/.ssh/id_rsa.pub | ssh user@server 'cat >> ~/.ssh/authorized_keys'`。

### GitHub
如果用ssh登录GitHub等网站，则需要将公钥复制到保存网站上。
验证：`ssh -T git@github.com`

如果22端口被限制访问，可以使用HTTPS的443端口。
验证：`ssh -T -p 443 git@ssh.github.com`
要对所有相关连接启用，在用户配置里加入：
```
Host github.com
  Hostname ssh.github.com
  Port 443
```

### 验证代理`ssh-agent`
默认私钥`~/.ssh/id_rsa`在创建时会被自动加入验证代理或执行`ssh-add`。
有时需要通过跳转服务器无密码登录另一个服务器时，需要在本机上加入跳转服务器上的私钥`ssh-add <(ssh jump-server 'cat .ssh/id_rsa')`。

`ssh-add -l` 查看生效的公钥指纹
`ssh-add -L` 查看生效的公钥内容
`ssh-keygen -lf ~/.ssh/id_rsa.pub` 显示公钥的长度，指纹及注释

## 配置文件
client用户配置文件：`~/.ssh/config`
server`sshd`配置文件：`/etc/ssh/sshd_config`

## Trouble Shooting
加上参数`ssh -vvv user@server`可以输出更多debug信息。

权限错误`WARNING: UNPROTECTED XXX FILE!`，需设置正确的文件权限：
`~/.ssh/id_rsa` 600
`~/.ssh/id_rsa.pub` 600
`~/.ssh/known_hosts` 644
`~/.ssh` 755

## Reference
[GitHub SSH Help](https://help.github.com/categories/56/articles)


</xmp>
<script src="js/strapdown.js"></script>
</html>
